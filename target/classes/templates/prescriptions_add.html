<html th:replace="~{layout :: layout(~{::section}, ~{::script})}" xmlns:th="http://www.thymeleaf.org">
<section class="space-y-6 animate-in slide-in-from-bottom-5 duration-500">
    <div class="flex items-center justify-between">
        <h2 class="text-3xl font-black text-gray-900 tracking-tight">Nouvelle Ordonnance</h2>
        <a th:href="@{/prescriptions}"
            class="bg-gray-100 text-gray-500 p-3 rounded-2xl shadow-sm active:scale-95 transition-all">
            Retour
        </a>
    </div>

    <!-- Progress Bar -->
    <div class="flex gap-2 mb-6">
        <div id="step-bar-1" class="h-2 flex-1 bg-emerald-500 rounded-full transition-all"></div>
        <div id="step-bar-2" class="h-2 flex-1 bg-gray-200 rounded-full transition-all"></div>
    </div>

    <form th:action="@{/prescriptions/add}" method="POST" enctype="multipart/form-data"
        class="bg-white p-6 rounded-[2.5rem] shadow-sm border-2 border-gray-50 min-h-[400px] flex flex-col justify-between relative overflow-hidden">

        <!-- Step 1: Info -->
        <div id="step-1" class="step-content space-y-5">
            <h3 class="text-xl font-black text-gray-800">1. Informations</h3>

            <div>
                <label class="block text-sm font-bold text-gray-400 uppercase mb-2 ml-2">Pour qui ?</label>
                <select name="profileId"
                    class="w-full p-5 bg-emerald-50 border-2 border-emerald-100 rounded-[1.5rem] focus:border-emerald-500 outline-none font-black text-emerald-900 appearance-none">
                    <option th:each="p : ${profiles}" th:value="${p.id}" th:text="${p.firstName} + ' ' + ${p.lastName}">
                        Moi</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-400 uppercase mb-2 ml-2">MÃ©decin</label>
                <input type="text" name="doctorName" placeholder="Nom du MÃ©decin" required
                    class="w-full p-5 bg-emerald-50 border-2 border-emerald-100 rounded-[1.5rem] focus:border-emerald-500 outline-none font-black text-emerald-900 placeholder-emerald-300 text-lg">
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-400 uppercase mb-2 ml-2">HÃ´pital / Clinique</label>
                <input type="text" name="hospitalName" placeholder="Ex: HÃ´pital Dantec" required
                    class="w-full p-5 bg-gray-50 border-2 border-gray-100 rounded-[1.5rem] focus:border-emerald-500 outline-none font-bold text-lg">
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-400 uppercase mb-2 ml-2">Date</label>
                <input type="date" name="prescriptionDate" required
                    class="w-full p-5 bg-gray-50 border-2 border-gray-100 rounded-[1.5rem] focus:border-emerald-500 outline-none font-bold text-lg">
            </div>
        </div>

        <!-- Step 2: Upload -->
        <div id="step-2" class="step-content space-y-5 hidden">
            <h3 class="text-xl font-black text-gray-800">2. Document</h3>

            <div class="relative group">
                <input type="file" name="file" accept="image/*,.pdf" required onchange="previewFile()" id="fileInput"
                    class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">

                <div class="border-4 border-dashed border-gray-200 rounded-[2rem] p-8 text-center transition-all group-hover:border-emerald-300 group-hover:bg-emerald-50"
                    id="dropZone">
                    <div
                        class="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="17 8 12 3 7 8" />
                            <line x1="12" y1="3" x2="12" y2="15" />
                        </svg>
                    </div>
                    <p class="font-black text-gray-800 text-lg mb-1" id="fileName">Cliquez pour ajouter</p>
                    <p class="text-sm text-gray-400 font-bold">Photo ou PDF</p>
                </div>
            </div>

            <div class="bg-blue-50 text-blue-800 p-4 rounded-xl text-sm font-bold">
                ðŸ’¡ Astuce : Prenez une photo claire de l'ordonnance.
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex gap-3 mt-8 pt-4 border-t border-gray-100">
            <button type="button" id="prevBtn" onclick="prevStep()"
                class="hidden px-6 py-4 bg-gray-100 text-gray-600 rounded-2xl font-bold active:scale-95 transition-all">Retour</button>
            <button type="button" id="nextBtn" onclick="nextStep()"
                class="flex-1 px-6 py-4 bg-emerald-600 text-white rounded-2xl font-black text-lg shadow-lg shadow-emerald-200 active:scale-95 transition-all">Continuer</button>
            <button type="submit" id="submitBtn"
                class="hidden flex-1 px-6 py-4 bg-emerald-600 text-white rounded-2xl font-black text-lg shadow-lg shadow-emerald-200 active:scale-95 transition-all">Enregistrer</button>
        </div>
    </form>
</section>

<script>
    let currentStep = 1;
    const totalSteps = 2;

    function updateUI() {
        // Steps visibility
        document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
        document.getElementById(`step-${currentStep}`).classList.remove('hidden');

        // Buttons
        document.getElementById('prevBtn').classList.toggle('hidden', currentStep === 1);

        if (currentStep === totalSteps) {
            document.getElementById('nextBtn').classList.add('hidden');
            document.getElementById('submitBtn').classList.remove('hidden');
        } else {
            document.getElementById('nextBtn').classList.remove('hidden');
            document.getElementById('submitBtn').classList.add('hidden');
        }

        // Progress Bar
        for (let i = 1; i <= totalSteps; i++) {
            const bar = document.getElementById(`step-bar-${i}`);
            if (i <= currentStep) {
                bar.classList.remove('bg-gray-200');
                bar.classList.add('bg-emerald-500');
            } else {
                bar.classList.add('bg-gray-200');
                bar.classList.remove('bg-emerald-500');
            }
        }
    }

    function nextStep() {
        if (!validateStep(currentStep)) return;
        if (currentStep < totalSteps) {
            currentStep++;
            updateUI();
        }
    }

    function prevStep() {
        if (currentStep > 1) {
            currentStep--;
            updateUI();
        }
    }

    function validateStep(step) {
        if (step === 1) {
            const inputs = document.querySelectorAll('#step-1 input');
            for (let input of inputs) {
                if (!input.value) {
                    alert("Veuillez remplir tous les champs.");
                    return false;
                }
            }
        }
        if (step === 2) {
            const file = document.getElementById('fileInput').files[0];
            if (!file) {
                alert("Veuillez ajouter un fichier.");
                return false;
            }
        }
        return true;
    }

    function previewFile() {
        const file = document.getElementById('fileInput').files[0];
        if (file) {
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('dropZone').classList.add('border-emerald-500', 'bg-emerald-50');
        }
    }
</script>

</html>