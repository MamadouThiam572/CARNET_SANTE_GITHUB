<html th:replace="~{layout :: layout(~{::section}, ~{::script})}" xmlns:th="http://www.thymeleaf.org">
<section class="space-y-6 animate-in slide-in-from-bottom-5 duration-500">
    <div class="flex items-center justify-between">
        <h2 class="text-3xl font-black text-gray-900 tracking-tight">Nouveau RDV</h2>
        <a th:href="@{/calendar}"
            class="bg-gray-100 text-gray-500 p-3 rounded-2xl shadow-sm active:scale-95 transition-all">
            Retour
        </a>
    </div>

    <!-- Progress Bar -->
    <div class="flex gap-2 mb-6">
        <div id="step-bar-1" class="h-2 flex-1 bg-emerald-500 rounded-full transition-all"></div>
        <div id="step-bar-2" class="h-2 flex-1 bg-gray-200 rounded-full transition-all"></div>
    </div>

    <form th:action="@{/calendar/add}" method="POST"
        class="bg-white p-6 rounded-[2.5rem] shadow-sm border-2 border-gray-50 min-h-[400px] flex flex-col justify-between relative overflow-hidden">

        <!-- Step 1: Médecin & Spécialité -->
        <div id="step-1" class="step-content space-y-5">
            <h3 class="text-xl font-black text-gray-800">1. Avec qui ?</h3>

            <div>
                <label class="block text-sm font-bold text-gray-400 uppercase mb-2 ml-2">Pour qui ?</label>
                <select name="profileId"
                    class="w-full p-5 bg-emerald-50 border-2 border-emerald-100 rounded-[1.5rem] focus:border-emerald-500 outline-none font-black text-emerald-900 appearance-none">
                    <option th:each="p : ${profiles}" th:value="${p.id}" th:text="${p.firstName} + ' ' + ${p.lastName}">
                        Moi</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-400 uppercase mb-2 ml-2">Nom du Médecin</label>
                <input type="text" name="doctorName" placeholder="Dr. Sy" required
                    class="w-full p-5 bg-emerald-50 border-2 border-emerald-100 rounded-[1.5rem] focus:border-emerald-500 outline-none font-black text-emerald-900 placeholder-emerald-300 text-lg">
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-400 uppercase mb-2 ml-2">Spécialité</label>
                <input type="text" name="specialty" placeholder="Ex: Cardiologue" required
                    class="w-full p-5 bg-gray-50 border-2 border-gray-100 rounded-[1.5rem] focus:border-emerald-500 outline-none font-bold text-lg">
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-400 uppercase mb-2 ml-2">Lieu</label>
                <input type="text" name="location" placeholder="Ex: Hôpital Principal" required
                    class="w-full p-5 bg-gray-50 border-2 border-gray-100 rounded-[1.5rem] focus:border-emerald-500 outline-none font-bold text-lg">
            </div>
        </div>

        <!-- Step 2: Date & Heure -->
        <div id="step-2" class="step-content space-y-5 hidden">
            <h3 class="text-xl font-black text-gray-800">2. Quand ?</h3>

            <div>
                <label class="block text-sm font-bold text-gray-400 uppercase mb-2 ml-2">Date et Heure</label>
                <input type="datetime-local" name="dateTime" required
                    class="w-full p-5 bg-emerald-50 border-2 border-emerald-100 rounded-[1.5rem] focus:border-emerald-500 outline-none font-black text-emerald-900 text-xl">
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-400 uppercase mb-2 ml-2">Notes (Optionnel)</label>
                <textarea name="notes" placeholder="Rappel, documents à apporter..."
                    class="w-full p-5 bg-gray-50 border-2 border-gray-100 rounded-[1.5rem] focus:border-emerald-500 outline-none font-bold h-32"></textarea>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex gap-3 mt-8 pt-4 border-t border-gray-100">
            <button type="button" id="prevBtn" onclick="prevStep()"
                class="hidden px-6 py-4 bg-gray-100 text-gray-600 rounded-2xl font-bold active:scale-95 transition-all">Retour</button>
            <button type="button" id="nextBtn" onclick="nextStep()"
                class="flex-1 px-6 py-4 bg-emerald-600 text-white rounded-2xl font-black text-lg shadow-lg shadow-emerald-200 active:scale-95 transition-all">Continuer</button>
            <button type="submit" id="submitBtn"
                class="hidden flex-1 px-6 py-4 bg-emerald-600 text-white rounded-2xl font-black text-lg shadow-lg shadow-emerald-200 active:scale-95 transition-all">Confirmer
                RDV</button>
        </div>
    </form>
</section>

<script>
    let currentStep = 1;
    const totalSteps = 2;

    function updateUI() {
        // Steps visibility
        document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
        document.getElementById(`step-${currentStep}`).classList.remove('hidden');

        // Buttons
        document.getElementById('prevBtn').classList.toggle('hidden', currentStep === 1);

        if (currentStep === totalSteps) {
            document.getElementById('nextBtn').classList.add('hidden');
            document.getElementById('submitBtn').classList.remove('hidden');
        } else {
            document.getElementById('nextBtn').classList.remove('hidden');
            document.getElementById('submitBtn').classList.add('hidden');
        }

        // Progress Bar
        for (let i = 1; i <= totalSteps; i++) {
            const bar = document.getElementById(`step-bar-${i}`);
            if (i <= currentStep) {
                bar.classList.remove('bg-gray-200');
                bar.classList.add('bg-emerald-500');
            } else {
                bar.classList.add('bg-gray-200');
                bar.classList.remove('bg-emerald-500');
            }
        }
    }

    function nextStep() {
        if (!validateStep(currentStep)) return;
        if (currentStep < totalSteps) {
            currentStep++;
            updateUI();
        }
    }

    function prevStep() {
        if (currentStep > 1) {
            currentStep--;
            updateUI();
        }
    }

    function validateStep(step) {
        if (step === 1) {
            const inputs = document.querySelectorAll('#step-1 input');
            for (let input of inputs) {
                if (!input.value) {
                    alert("Veuillez remplir tous les champs.");
                    return false;
                }
            }
        }
        if (step === 2) {
            const dt = document.querySelector('input[name="dateTime"]').value;
            if (!dt) {
                alert("Veuillez choisir une date.");
                return false;
            }
        }
        return true;
    }
</script>

</html>